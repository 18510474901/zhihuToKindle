


如何用 Python 写一个抓取深交所或者上交所公司股东增持减持消息并向指定邮箱发送邮件的脚本？ - 爬虫（计算机网络） - 知乎






--------------------Link http://www.zhihu.com/question/32074399 ----------------------





--------------------Detail----------------------

交易所在每个交易日结束后，交易所会公布相关相关公司高管增减持的情况。上交所：董事、监事、高级管理人员持有本公司股份变动情况深交所：深圳证券交易所想请教各位，如何编一个能抓取自己指定股份高管增减持变动的脚本，不用每天抓取，例如：星期二运行一次，抓取星期一增减持变动情况。本人财经类院校毕业，软件实在太弱，望各位不吝赐教。如果有其他方式可以达到这种目的，也可以。谢谢。

-------------------------answer 0 via  -------------------------


其实题主要的功能很简单，只是爬数据。我看到标签里有“数据挖掘”，但是这算不上数据挖掘，因为仅仅是爬数据，没有分析。Python的爬虫很简单。贴一个教程地址：Python爬虫学习系列教程我最近也写了个玩玩，因为一直是写Java，Python也是刚学，因此写得并不顺手。我的爬虫是爬爱鼠绘的海贼更新情况的，一更新就发邮件通知我。原理很简单，分以下几步：1. 发送请求，获取页面的html源码2. 按照一定的规则解析取得的html源码，取得你要的信息（info1）3. 隔一段时间再请求，重复2，得到信息info2，将两次取得的信息比较，如果不一样说明发生了变化，这时就可以发邮件了。然后将info2赋值给info1。4. 重复3获取某个页面的html源码的代码如下：import urllib2
def getPage(pageURL):
    '''
    获取指定地址的html源码
    '''
    request = urllib2.Request(pageURL)
    response = urllib2.urlopen(request)
    result = response.read()
    return  result

print getPage(r'http://www.sse.com.cn/disclosure/listedinfo/credibility/change/')
这样就打印了html代码了。然后就是第2步，解析。一般有两种做法吧，一是按照dom结构进行解析，多数是使用第三方包，这种做法对题主这类非计算机专业的人士来说可能就要花点时间去了解（其实也不难，就是未接触过的情况下要花时间而已），第二种是直接使用正则表达式进行匹配，这种做法也是要学下正则表达式。我比较喜欢第一种做法，但是可能要使用第三方包，Python的话这样做移植性就不好了，所以我是用正则表达式的。解析的工作主要是分析其页面的源码，分析结构，分析来源（是使用js异步加载的还是直接返回的），是否有身份验证等。这一步是最费功夫的。例如这两个交易所的数据，第一页数据是直接返回的，第二页是异步加载的，需要分析请求的数据，可能要处理cookie。要写一个完善的爬虫还是需要一定的专业知识的。第三步里面的发邮件，也不难。只不过如果是用现在大平台的邮箱，可能会有反垃圾邮件机制，要注意邮件的内容，尽量使其像人写的，并且不要高频率发送内容相似的邮件，否则可能会被禁用。#coding:utf8
import smtplib
import json
from email import Encoders
from email.mime.base import MIMEBase
from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText
from email.header import Header
from testMail import toEmail


def sendMail(fromEmail, username,  password, serverAddress, subject, htmlContent, toEmail):
    '''
    fromEmail: 使用哪个邮箱地址发送
    username: 登陆邮箱服务器的用户名，一般与fromEmail相同
    password: 登陆的密码
    serverAddress: 邮箱服务的地址（包含端口）
    subject: 邮件主题
    htmlContent: 邮件正文，使用html格式编写
    toEmail: 要发送到的邮箱地址，可以写多个
    '''
    msg = MIMEMultipart('alternative')
    msg['Subject'] = subject
    msg['From'] = fromEmail
    msg['To'] = ', '.join(toEmail)
    msg["Accept-Language"]="zh-CN"                      #指定语言环境是中文
    msg["Accept-Charset"]="ISO-8859-1,utf-8"        #指定使用特定的编码，防止乱码
    part = MIMEText(htmlContent, 'html', 'UTF-8')
    msg.attach(part)
    
    s = smtplib.SMTP(serverAddress)
    print "Try to login"
    s.login(username, password)
    print "login successfully, try to send"
    s.sendmail(fromEmail, toEmail, msg.as_string())
    print "send successfully"
    s.quit()
    

sendMail(fromEmail='fromsomebody@163.com', 
         username="fromsomebody@163.com", 
         password="somebodyspass", 
         serverAddress='smtp.163.com:25', 
         subject='Python邮件代码测试', 
         htmlContent="plain text content",
        toEmail= ['tosomebody@xxx.com'])
以上是发送邮件的代码。这是抓取并解析上海证券交易所相关信息的代码，定时启动、检测变化以及发送邮件并没有实现。#coding:utf8
import urllib2
import time
import smtplib
from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText
import re

def testMatch():
    remoteoteURL = r'http://www.sse.com.cn/disclosure/listedinfo/credibility/change/'
    request = urllib2.Request(remoteoteURL)
    response = urllib2.urlopen(request)
    result = response.read()        #获取响应的HTML

    #匹配表格标题的正则表达式
    titlePatternStr = r'<table  class="tablestyle">.*?<th>(\S*)</th>\n\s*<th>(\S*)</th>.*?<th>(\S*)</th>.*?<th>(\S*)</th>.*?<th>(\S*)</th>.*?<th>(\S*)</th>.*?<th>(\S*)</th>.*?<th>(\S*)</th>.*?<th>(\S*)</th>.*?<th>(\S*)</th>.*?<th>(\S*)</th>.*?<th>(\S*)</th>.*?<th>(\S*)</th>'
    
    #匹配表格内容的正则表达式
    valuePatternStr = r' <tr style="background-color.*?<td class="nowrap">(\d*?)</td>.*?<td class="nowrap">(\S*)</td>.*?<td class="nowrap">(\S*)</td>.*?<td class="nowrap">(\S*)</td>.*?<td class="nowrap">(\S*)</td>.*?<td class="nowrap">(\S*)</td>.*?document.write\(\$.format\(\'([\.,\d]*)\'.*?document.write\(\$.format\(\'([\.,\d]*)\'.*?document.write\(\$.format\(\'([\.,\d]*)\'.*?document.write\(\$.format\(\'([\.,\d]*)\'.*?<td class="nowrap">(\S*)</td>.*?<td class="nowrap">(\S*)</td>.*?<td class="nowrap">(\S*)</td>'
    valuePattern = re.compile(valuePatternStr, re.S)
    titlePattern = re.compile(titlePatternStr, re.S)
    
    #匹配表格标题
    titles = re.findall(titlePattern, result)
    
    #匹配表格内容
    items = re.findall(valuePattern, result)
    
    #根据匹配的结果生成HTML表格
    tableStr = "<table>"
    titleStr = "<tr>"
    for title in titles:
        for tt in title:
            titleStr += '<th>'+ str(tt)+'</th>'
    titleStr += "</tr>"
    tableStr += titleStr
    for item in items:
        tableStr += "<tr>"
        for name in item:
            tableStr += "<td>%s</td>" % (name)
        tableStr += "</tr>"
    tableStr += "</table>"
    print tableStr 
   
   
testMatch() 



-------------------------answer 1 via  -------------------------


砸场子，MATLAB 实现样例和工具箱：舆情文本数据-上市公司公告文件数据FQuantToolBoxHelpOnLine辅助函数和工具-MATLAB发送邮件通用函数FQuantToolBoxHelpOnLinefunction MatlabSendMailGeneral(subject, content, TargetAddress, Attachments,SourceAddress,password)
%% by LiYang_faruto
% Email:farutoliyang@foxmail.com
% 2015/05/01
%% 输入输出设置
if nargin < 6 || isempty(password)
 str = ['请输入发送邮件的邮箱密码'];
 disp(str);
 return;
end
if nargin < 5 || isempty(SourceAddress)
 str = ['请输入发送邮件的邮箱地址'];
 disp(str);
 return;
end
if nargin < 4
 Attachments = [];
end
if nargin < 3 || isempty(TargetAddress)
 TargetAddress = SourceAddress;
end
if nargin < 2 || isempty(content)
 content = 'contentTest(FromMatlab)';
end
if nargin < 1 || isempty(subject)
 subject = 'subjectTest(FromMatlab)';
end

%% SMTP_Server Get
ind = find( SourceAddress == '@', 1);
temp = SourceAddress(ind+1:end);

FieldName = temp;
SMTP_Server = ['smtp.',FieldName];

% ind = find( temp == '.', 1 );
% FieldName = temp(1:ind-1);
% if strcmpi(FieldName, 'foxmail')
%     FieldName = 'qq';
% end
% SMTP_Server = ['smtp.',FieldName,'.com'];

str = ['SMTP_Server=',SMTP_Server];
disp(str);
disp('即将发送邮件，若发送邮件不成功，请手动修改代码调整SMTP_Server');
%% 发送邮件
try
 setpref('Internet','SMTP_Server',SMTP_Server);%SMTP服务器，记住要改成自己邮箱的smtp（百度一下就行了）
 setpref('Internet','E_mail',SourceAddress);
 setpref('Internet','SMTP_Username',SourceAddress);
 setpref('Internet','SMTP_Password',password);
 props = java.lang.System.getProperties;
 props.setProperty('mail.smtp.auth','true');
 if isempty(Attachments)
     sendmail(TargetAddress, subject, content);
 else
     sendmail(TargetAddress, subject, content, Attachments);
 end
catch err
 str = ['发生异常'];
 disp(str);
 for i = 1:size(err.stack,1)
     StrTemp = ['FunName：',err.stack(i).name,' Line：',num2str(err.stack(i).line)];
     disp(StrTemp);
 end
%     str = ['SMTP_Server=',SMTP_Server];
%     disp(str);
%     disp('若发送邮件不成功，请手动修改代码调整SMTP_Server');
end

%%
disp('邮件发送完毕！');
DateTimedemo = datestr(now,'yyyy-mm-dd HH:MM:SS')



-------------------------answer 2 via  -------------------------


网上有不少教程，不过你也可以学一下  scrapy ，这个框架的爬虫其实最简单。其它方法有火车头这样的软件。当然，对于你来说更好的方法是花钱买数据源。


-------------------------answer 3 via  -------------------------


这类没有异步加载没有反爬虫机制的网站。。你花一个小时上网搜一下再花一个小时学习一下。并在这里问有用多了。给你一口鸡汤：如果你认为自己不能那就真的不能了。如果你觉得自己非专业干啥会很难那就真的很难了。搜索关键字：Python 爬虫。千万别像楼上说的用Java 


-------------------------answer 4 via  -------------------------


谢邀，虽然没专门写过爬股市数据的爬虫，也许以后会尝试。爬虫特别好玩，我来分享一个我最近写的爬虫项目吧。从我QQ空间开始的蜘蛛网式的爬虫程序，程序断断续续的运行了两周。总共爬到了腾讯3000万QQ数据，其中有300万包含用户的详细数据。目前已经爬到我的第7圈好友（depth=7）共3000万数据，在网速和程序稳定运行的时候，曾经最快一天能爬500W数据。再看看，我根据这份数据生成的一些有趣的统计图吧1、大家一般都在啥时候发说说呢？从图中看出一天最冷门的时候是凌晨4点，这时全国正在睡觉的人最多。 大家最亢奋的是晚上10点到11点，人们都喜欢睡前看看别人的空间，发条说说。中午12点左右也有一波小高峰。2、中国人都喜欢在几月生小孩呢？最热门的是1月份和10月份，最冷门的是4月份。 4月份生日的最少好理解，中国人不喜欢4这个数字呗。1月最高估计是默认的生日1月1日，很多人其实没填生日。总体来看，上半年的出生率小于下半年的。你知道为什么吗？ 大数据有意思吧！！ 我觉得太好玩了，后面还有很多呢。3、这是我目前爬取的用户所在地分布你能猜出我是哪的了吗？前四名分别为：广东，湖南，四川，江苏。 没错，我就是湖南的！ 湖南人在广东打工的超级多，这也能理解为什么广东排名第一了。江苏是我上学的地方，有点琢磨不透的是四川和我非亲非故的居然排第3名，难道是四川人民交际能力全国第一？4、数据人群的年龄分布一不小心就暴漏了我的年龄，没错。我就是那个最高值的1990年；从目前的数据来看，无论是分布地区以及年龄阶段与我的关联还非常大，随着数据量的不断增加这种关联会逐渐变小，统计图也会逐渐接近全国用户的真实情况。5、数据人群性别分布男比女足足多了23%的人数，我分析认为实际差距应该是不大的，但女生在设置QQ空间访问权限时普遍要比男生的高。所以我爬取的数据中男生居多。6、下面系列图是根据一些“关键字”在说说中出现的频率统计出来的，相当有意思。6.1 图说股市在知乎“能利用爬虫技术做到哪些很酷很有趣很有用的事情？” 有一个google实习的哥们@Emily L爬了400亿条tweet也做了很多有趣的分析，其中提到一篇关于利用twitter上人的心情来预测股市的论文也很有意思。如果当我们拥有海量的QQ空间最新说说，和sina微博数据。我想，用它们来做一些股市或者其它方面的分析预测是可行的，准确度应该也是非常高的。我接下来可能会考虑去做这件有趣的事情。将股票中的关键字做海量数据分析，比如会得出当日讨论股票排行榜。进而能得到海量讨论股票的用户，再通过市场的实际反馈找出股票上涨及下跌的正相关因子，再对这些海量用户进行分析计算得出最靠谱股票推荐大神排行榜。对这些用户分级，分优先度及抓取密度来拿数据。用这些数据分析出哪些是靠谱的股票肯定靠谱。6.2 群众讨论最多的明星排行榜，还是很靠谱的。6.3 最为用户喜爱的手机品牌6.4 人们最喜欢谈论的互联网公司，阿里之所以这么低估计是大家都喜欢叫它淘宝或者天猫吧。 取这么多名字，自讨苦吃。6.5 QQ空间中讨论的最为频繁的社交平台排行榜。6.6 生活的统计图爱>恨； 开心>伤心; 笑声>叹气声； 吃货很多； 谁特么说中国不幸福了，这满满的都是正能量数据啊。好了，其实还可以做很多其它的分析。如果大家有什么有趣的数据分析想知道的，那就给我留言吧。


-------------------------answer 5 via  -------------------------


kettle轻松搞定


-------------------------answer 6 via  -------------------------


广发金工写过一个插件，如果你有基金公司的朋友可以直接找他们要试试看


-------------------------answer 7 via  -------------------------


和俺弄的有点像。采集招考信息网站，并在更新时候发邮件给俺。代码不复杂，百度谷歌网站搜索下都有的。俺的玩具代码就不贴咯！
